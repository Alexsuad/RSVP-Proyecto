<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- File: public/app/recover-code.html                            -->
<!-- Ruta relativa: public/app/recover-code.html                   -->
<!-- PropÃ³sito: PÃ¡gina para recuperar el cÃ³digo de invitaciÃ³n      -->
<!-- Rol: Permite solicitar el envÃ­o del cÃ³digo por email o        -->
<!--      telÃ©fono, sin revelar si el invitado existe o no.        -->
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>RSVP Boda â€“ Recuperar cÃ³digo</title>

  <!-- --- SecciÃ³n: Metadatos y hojas de estilo base --- -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/layout.css" />
  <link rel="stylesheet" href="/assets/css/forms.css" />
  <link rel="stylesheet" href="/assets/css/login.css" />
  <link rel="stylesheet" href="/assets/css/recover-code.css" />

</head>
<body>
  <!-- --- SecciÃ³n: Cabecera del sitio (hero header) --- -->
  <header class="hero-header">
    <div class="hero-header__content">
      <h1 class="hero-header__title">Daniela & Cristian</h1>
      <p class="hero-header__subtitle">
        Una fecha, un lugar, un amor eterno. Solo falta tu presencia.
      </p>
    </div>
    <!-- --- SecciÃ³n: Selector de Idioma (sin lÃ³gica aÃºn) --- -->
    <div class="lang-switcher">
      <button class="lang-switcher__btn" data-lang="es" title="EspaÃ±ol">ğŸ‡ªğŸ‡¸</button>
      <button class="lang-switcher__btn" data-lang="en" title="English">ğŸ‡¬ğŸ‡§</button>
      <button class="lang-switcher__btn" data-lang="ro" title="RomÃ¢nÄƒ">ğŸ‡·ğŸ‡´</button>
    </div>
  </header>

  <!-- --- SecciÃ³n: Contenido principal (formulario de recuperaciÃ³n) --- -->
  <main class="site-main">
    <div class="container">
      <section class="auth-card">
        <header class="auth-card__header">
          <h2 class="auth-card__title">Recuperar cÃ³digo de invitaciÃ³n</h2>
          <p class="auth-card__subtitle">
            Si no recuerdas tu cÃ³digo, puedes solicitarlo usando el correo electrÃ³nico
            o el nÃºmero de telÃ©fono que diste a los novios.
          </p>
        </header>

        <!-- --- SecciÃ³n: Ãrea de mensajes generales del formulario --- -->
        <div id="form-message" class="form-message" hidden></div>

        <!-- --- SecciÃ³n: Formulario de recuperaciÃ³n de cÃ³digo --- -->
        <form id="recover-form" class="auth-card__form" novalidate>
          <!-- Campo: Correo electrÃ³nico -->
          <div class="form-field">
            <label for="email" class="form-field__label">
              Correo electrÃ³nico (opcional)
            </label>
            <input
              id="email"
              name="email"
              type="email"
              class="form-field__input"
              autocomplete="email"
              placeholder="tu-correo@ejemplo.com"
            />
            <small id="email-error" class="field-error" hidden></small>
          </div>

          <!-- Campo: TelÃ©fono -->
          <div class="form-field">
            <label for="phone" class="form-field__label">
              TelÃ©fono (opcional)
            </label>
            <input
              id="phone"
              name="phone"
              type="tel"
              class="form-field__input"
              autocomplete="tel"
              placeholder="+34 600 123 123"
            />
            <small id="phone-error" class="field-error" hidden></small>
          </div>

          <!-- Ãrea de acciones del formulario -->
          <div class="form-actions">
            <button type="submit" id="recover-submit" class="btn btn-primary">
              Solicitar recuperaciÃ³n
            </button>
          </div>
        </form>

        <!-- --- SecciÃ³n: Enlace para volver al inicio (login) --- -->
        <footer class="auth-card__footer">
          <a href="/app/login.html" class="auth-card__link">
            â† Volver al inicio
          </a>
        </footer>
      </section>
    </div>
  </main>

  <!-- --- SecciÃ³n: Pie de pÃ¡gina del proyecto acadÃ©mico --- -->
  <footer class="site-footer">
    <div class="container">
      <small class="site-footer__text">
        Proyecto acadÃ©mico â€“ Sistema RSVP para bodas
      </small>
    </div>
  </footer>

  <!-- --- SecciÃ³n: LÃ³gica de validaciÃ³n y envÃ­o del formulario --- -->
  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SecciÃ³n: Referencias a elementos del DOM
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const recoverForm = document.getElementById('recover-form');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const emailError = document.getElementById('email-error');
    const phoneError = document.getElementById('phone-error');
    const formMessage = document.getElementById('form-message');
    const submitButton = document.getElementById('recover-submit');

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SecciÃ³n: Utilidades de mensajes y estado visual
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function clearErrors() {
      formMessage.hidden = true;
      formMessage.textContent = '';
      formMessage.classList.remove('form-message--error', 'form-message--success');

      emailError.hidden = true;
      emailError.textContent = '';
      emailInput.classList.remove('form-field__input--error');

      phoneError.hidden = true;
      phoneError.textContent = '';
      phoneInput.classList.remove('form-field__input--error');
    }

    function showFormError(message) {
      formMessage.textContent = message;
      formMessage.classList.remove('form-message--success');
      formMessage.classList.add('form-message--error');
      formMessage.hidden = false;
    }

    function showFormSuccess(message) {
      formMessage.textContent = message;
      formMessage.classList.remove('form-message--error');
      formMessage.classList.add('form-message--success');
      formMessage.hidden = false;
    }

    function setLoading(isLoading) {
      if (isLoading) {
        submitButton.disabled = true;
        submitButton.textContent = 'Enviando...';
      } else {
        submitButton.disabled = false;
        submitButton.textContent = 'Solicitar recuperaciÃ³n';
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SecciÃ³n: ValidaciÃ³n y normalizaciÃ³n de datos
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function validateEmail(value) {
      const trimmed = value.trim();
      if (!trimmed) return null; // es opcional
      const emailPattern = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
      if (!emailPattern.test(trimmed)) {
        return 'Escribe un correo electrÃ³nico vÃ¡lido.';
      }
      return null;
    }

    function validatePhone(value) {
      const trimmed = value.trim();
      if (!trimmed) return null; // es opcional
      const phonePattern = /^\+?[0-9\s-]{6,20}$/;
      if (!phonePattern.test(trimmed)) {
        return 'Escribe un nÃºmero de telÃ©fono vÃ¡lido.';
      }
      return null;
    }

    function sanitizePhone(rawPhone) {
      const trimmed = rawPhone.trim();
      if (!trimmed) return null;
      // Se mantienen solo dÃ­gitos y el signo +
      const cleaned = trimmed.replace(/[^0-9+]/g, '');
      return cleaned || null;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SecciÃ³n: EnvÃ­o del formulario y comunicaciÃ³n con la API
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    recoverForm.addEventListener('submit', async function (event) {
      event.preventDefault();
      clearErrors();

      const rawEmail = emailInput.value;
      const rawPhone = phoneInput.value;

      // Regla principal: al menos uno de los dos campos debe tener datos
      if (!rawEmail.trim() && !rawPhone.trim()) {
        showFormError('Debes introducir al menos tu correo electrÃ³nico o tu telÃ©fono.');
        emailInput.classList.add('form-field__input--error');
        phoneInput.classList.add('form-field__input--error');
        return;
      }

      const emailValidation = validateEmail(rawEmail);
      const phoneValidation = validatePhone(rawPhone);

      let hasError = false;

      if (emailValidation) {
        emailError.textContent = emailValidation;
        emailError.hidden = false;
        emailInput.classList.add('form-field__input--error');
        hasError = true;
      }

      if (phoneValidation) {
        phoneError.textContent = phoneValidation;
        phoneError.hidden = false;
        phoneInput.classList.add('form-field__input--error');
        hasError = true;
      }

      if (hasError) {
        return;
      }

      const sanitizedPhone = sanitizePhone(rawPhone);

      const payload = {
        email: rawEmail.trim() || null,
        phone: sanitizedPhone,
        language: 'es'
      };

      setLoading(true);

      try {
        const response = await fetch('http://127.0.0.1:8000/api/recover-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          // Mensaje neutro: no se revela si el contacto estÃ¡ registrado o no
          showFormSuccess('Si tus datos estÃ¡n registrados, recibirÃ¡s un correo con tu cÃ³digo de invitaciÃ³n en unos minutos.');
          recoverForm.reset();
          return;
        }

        if (response.status === 400) {
          showFormError('Los datos introducidos no son vÃ¡lidos. Revisa el correo o el telÃ©fono.');
        } else if (response.status === 429) {
          showFormError('Has realizado demasiadas solicitudes. Espera unos minutos antes de intentarlo de nuevo.');
        } else {
          showFormError('Ha ocurrido un error al procesar tu solicitud. IntÃ©ntalo de nuevo mÃ¡s tarde.');
        }
      } catch (error) {
        console.error(error);
        showFormError('No se ha podido conectar con el servidor. Revisa tu conexiÃ³n.');
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
